name: export_plugin
on:
  release:
    types: [published]
permissions:
  contents: write

env:
  PLUGIN_NAME: moe_geoportal_loader
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.target_commitish }}
          fetch-depth: 0
          persist-credentials: true
      # Temporarily rename metadata file whose contents are to be rewritten
      - name: rename some files to rewrite
        run: |
          cp ./metadata.txt ./metadata.old.txt
          cp ./pyproject.toml ./pyproject.old.toml
      # Write version information in metadata.txt and pyproject.toml from github release tag
      - name: metadata
        run: |
          TAG=${{ github.event.release.tag_name }}
          VERSION=${TAG#v}
          sed -e "s/{{PLUGIN_VERSION}}/${VERSION}/g" ./metadata.old.txt > ./metadata.txt
          sed -E 's/^[[:space:]]*version *= *".*"/version = "'"${VERSION}"'"/' ./pyproject.old.toml > ./pyproject.toml
          rm ./metadata.old.txt ./pyproject.old.toml
      - name: Commit and push version bump to repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ github.event.release.tag_name }}
          VERSION=${TAG#v}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml
          if ! git diff --cached --quiet; then
            git commit -m "chore(release): bump pyproject version to ${VERSION}"
            git push origin HEAD:${{ github.event.release.target_commitish }}
          else
            echo "No changes to commit"
          fi
      - name: Create Plugin Directory
        run: |
          mkdir ${{env.PLUGIN_NAME}}
          find . -type f | grep -ve './.git' \
            -ve '.github' \
            -ve './.vscode' \
            -ve '__pycache__/' \
            -ve './test' \
            -ve './tests' \
            -ve './pyproject.toml' \
            -ve './.gitignore' \
            -ve './.python-version' \
            -ve './README.md' \
            -ve './uv.lock' \
            -ve './.venv' \
            -ve './.ruff_cache' \
            -ve './.DS_Store' | xargs -I src cp --parents src ${{env.PLUGIN_NAME}}
      - name: Create Archive
        run: |
          zip -r ${{env.PLUGIN_NAME}}.zip ./${{env.PLUGIN_NAME}}
      - name: Upload release asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} ${{env.PLUGIN_NAME}}.zip#${{env.PLUGIN_NAME}}
